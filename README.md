# Port Bulk User Delete

Tools for deleting users from **Port Admin Service** and **Auth0** in bulk.

## Workflow

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  01_prepare.sh  │ ──▶ │  02_delete.sh   │ ──▶ │  03_verify.sh   │
│                 │     │                 │     │                 │
│ Get Auth0 IDs   │     │ Delete users    │     │ Confirm deleted │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                       │                       │
        ▼                       ▼                       ▼
  input/users.csv        output/users_ready.csv   logs/verify_*.log
```

## Quick Start

```bash
# 1. Set your Auth0 token and region
export AUTH0_TOKEN='your-management-api-token'
export REGION='eu'   # or 'us'

# 2. Put your user list in input/users.csv

# 3. Run the scripts in order
./01_prepare.sh    # Get Auth0 IDs
./02_delete.sh     # Delete users
./03_verify.sh     # Verify deletion
```

---

## Prerequisites

1. **Auth0 Management API Token** with `read:users` and `delete:users` scopes
2. **bash**, **curl**, and **python3** installed

### Getting an Auth0 Token

1. Go to [Auth0 Dashboard](https://manage.auth0.com/)
2. Navigate to: **Applications** → **APIs** → **Auth0 Management API**
3. Click the **API Explorer** tab
4. Copy the token (expires in 24 hours)

---

## Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `AUTH0_TOKEN` | **Yes** | - | Auth0 Management API token |
| `REGION` | No | *(prompted)* | Region: `eu` or `us` |

### Setting Environment Variables

```bash
export AUTH0_TOKEN='your-management-api-token'
export REGION='eu'   # or 'us'
```

---

## File Structure

```
port-bulk-user-delete/
├── 01_prepare.sh              # Step 1: Get Auth0 IDs
├── 02_delete.sh               # Step 2: Delete users
├── 03_verify.sh               # Step 3: Verify deletion
├── README.md
├── input/
│   └── users.csv              # Your input file (Email, Port Name)
├── output/
│   └── users_ready.csv        # Prepared file with Auth0 IDs
└── logs/
    ├── prepare_found.log      # Users found in Auth0
    ├── prepare_not_found.log  # Users not found in Auth0
    ├── prepare_errors.log     # Errors during lookup
    ├── delete_admin_success.log
    ├── delete_admin_errors.log
    ├── delete_auth0_success.log
    ├── delete_auth0_errors.log
    └── verify_still_exists.log
```

---

## Step 1: Prepare (01_prepare.sh)

Looks up Auth0 user IDs for each email.

### Input: `input/users.csv`

```csv
Email,Port Name
john.doe@example.com,John Doe
jane.smith@example.com,Jane Smith
dustin.savage@example.com,
```

> **Note:** If Port Name is empty, it's derived from the email (e.g., `dustin.savage` → `Dustin Savage`)

### Output: `output/users_ready.csv`

```csv
Email,Port Name,Auth0 ID
john.doe@example.com,John Doe,oidc|okta|abc123
jane.smith@example.com,Jane Smith,oidc|okta|def456
dustin.savage@example.com,Dustin Savage,oidc|okta|ghi789
```

### Logs

| File | Contents |
|------|----------|
| `logs/prepare_found.log` | Users found in Auth0 |
| `logs/prepare_not_found.log` | Users not in Auth0 |
| `logs/prepare_errors.log` | API errors |

---

## Step 2: Delete (02_delete.sh)

Deletes users from Admin Service and Auth0.

### Input: `output/users_ready.csv`

Uses the file generated by `01_prepare.sh`.

### Output Summary

```
=== Delete Summary ===

Processed: 121 users

Admin Service:
  Deleted:   50
  Not found: 71 (user wasn't in Admin Service)
  Failed:    0

Auth0:
  Deleted:   100
  Not found: 10 (user wasn't in Auth0)
  Failed:    0
  Skipped:   11 (no Auth0 ID)
```

### Logs

| File | Contents |
|------|----------|
| `logs/delete_admin_success.log` | Admin Service deletions |
| `logs/delete_admin_errors.log` | Admin Service errors |
| `logs/delete_auth0_success.log` | Auth0 deletions |
| `logs/delete_auth0_errors.log` | Auth0 errors |

---

## Step 3: Verify (03_verify.sh)

Confirms users were actually deleted.

### Output Summary

```
=== Verify Summary ===

Processed: 121 users

Admin Service:
  ✓ Gone:          121
  ⚠ Still exists:  0
  ? Error:         0

Auth0:
  ✓ Gone:          110
  ⚠ Still exists:  0
  ? Error:         0
  - Skipped:       11

✓ SUCCESS: All users have been deleted!
```

### Log

| File | Contents |
|------|----------|
| `logs/verify_still_exists.log` | Users that still exist (need attention) |

---

## Regions

| Region | Auth0 Domain | Admin API |
|--------|--------------|-----------|
| EU | `port-prod.eu.auth0.com` | `admin-service.production-internal.getport.io` |
| US | `port-prod.us.auth0.com` | `admin-service.us-production-internal.getport.io` |

---

## Error Codes

| HTTP Status | Meaning |
|-------------|---------|
| 200/204 | Success |
| 404 | User not found |
| 401 | Invalid or expired token |
| 403 | Token missing required scope |
| 429 | Rate limited |
